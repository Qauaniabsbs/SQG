import gradio as gr
from transformers import pipeline
from PIL import Image

# ----------------------------------------------------------------------
# 1. –ú–û–î–ï–õ–¨–î–ï–†–î–Ü –ñ“Æ–ö–¢–ï–£ (512MB RAM —à–µ–∫—Ç–µ—É—ñ “Ø—à—ñ–Ω –æ“£—Ç–∞–π–ª–∞–Ω–¥—ã—Ä—ã–ª“ì–∞–Ω)
# ----------------------------------------------------------------------

# 1.1. –ê—É–∞ —Ä–∞–π—ã/–°“±—Ä–∞“õ-–ñ–∞—É–∞–ø (Question Answering - QA)
# –ö—ñ—à—ñ—Ä–µ–∫, –æ“£—Ç–∞–π–ª–∞–Ω–¥—ã—Ä—ã–ª“ì–∞–Ω –º–æ–¥–µ–ª–¥—ñ “õ–æ–ª–¥–∞–Ω—É
qa_model = pipeline(
    "question-answering",
    model="distilbert-base-cased-distilled-squad",
    tokenizer="distilbert-base-cased-distilled-squad",
    device=-1 # CPU-–¥–∞ –∂“±–º—ã—Å —ñ—Å—Ç–µ—É
)

# 1.2. ”®—Å—ñ–º–¥—ñ–∫/–ú–∞–ª –ê—É—Ä—É—ã –¢–∞–Ω—É (Classification)
# PREMIUM —Ñ—É–Ω–∫—Ü–∏—è—Å—ã, –±—ñ—Ä–∞“õ —Ç–µ–≥—ñ–Ω –∂–æ—Å–ø–∞—Ä–¥–∞ –∂“±–º—ã—Å —ñ—Å—Ç–µ—É—ñ “Ø—à—ñ–Ω –∫—ñ—à—ñ –º–æ–¥–µ–ª—å
classifier = pipeline(
    "image-classification",
    model="google/vit-base-patch16-224-in21k",
    device=-1 # CPU-–¥–∞ –∂“±–º—ã—Å —ñ—Å—Ç–µ—É
)

# 1.3. –ñ–∞–ª–ø—ã –°–∏–ø–∞—Ç—Ç–∞–º–∞ (Image Captioning)
# –¢–µ–≥—ñ–Ω —Ñ—É–Ω–∫—Ü–∏—è, BLIP-—Ç—ñ“£ –∫—ñ—à—ñ—Ä–µ–∫ –Ω“±—Å“õ–∞—Å—ã–Ω “õ–æ–ª–¥–∞–Ω—É
captioner = pipeline(
    "image-to-text",
    model="Salesforce/blip-image-captioning-base",
    device=-1 # CPU-–¥–∞ –∂“±–º—ã—Å —ñ—Å—Ç–µ—É
)

# ----------------------------------------------------------------------
# 2. –§–£–ù–ö–¶–ò–Ø–õ–ê–†
# ----------------------------------------------------------------------

# 2.1. –ê—É–∞ —Ä–∞–π—ã (–°“±—Ä–∞“õ-–ñ–∞—É–∞–ø)
def weather_predictor(city_name: str) -> str:
    """–ë–∞—è–Ω-”®–ª–≥–∏–π –∞–π–º–∞“ì—ã–Ω–¥–∞“ì—ã –∂”ô–Ω–µ “ö–∞–∑–∞“õ—Å—Ç–∞–Ω–¥–∞“ì—ã “õ–∞–ª–∞/–∂–µ—Ä –∞—Ç–∞—É—ã–Ω–∞ –±–∞–π–ª–∞–Ω—ã—Å—Ç—ã –∂–∞–ª–ø—ã –∞“õ–ø–∞—Ä–∞—Ç –±–µ—Ä–µ–¥—ñ."""
    # –ë–∞—è–Ω-”®–ª–≥–∏–π –º–µ–Ω “ö–∞–∑–∞“õ—Å—Ç–∞–Ω“ì–∞ –∞—Ä–Ω–∞–ª“ì–∞–Ω ”ô–º–±–µ–±–∞–ø –∫–æ–Ω—Ç–µ–∫—Å—Ç
    context = (
        f"–ú–æ“£“ì–æ–ª–∏—è, –ë–∞—è–Ω-”®–ª–≥–∏–π –∞–π–º–∞“ì—ã - –∫–ª–∏–º–∞—Ç—ã “õ–∞—Ç–∞“£, –±–∏—ñ–∫ —Ç–∞—É–ª—ã –∂–µ—Ä. "
        f"“ö–∞–∑–∞“õ—Å—Ç–∞–Ω–Ω—ã“£ –∫–ª–∏–º–∞—Ç—ã ”ô—Ä—Ç“Ø—Ä–ª—ñ (—Å–æ–ª—Ç“Ø—Å—Ç—ñ–∫ —Å—É—ã“õ, –æ“£—Ç“Ø—Å—Ç—ñ–∫ —ã—Å—Ç—ã“õ). "
        f"”®–ª–≥–∏–π - –∞–π–º–∞“õ –æ—Ä—Ç–∞–ª—ã“ì—ã. –ê–ª–º–∞—Ç—ã, –ê—Å—Ç–∞–Ω–∞ (–ù“±—Ä-–°“±–ª—Ç–∞–Ω), –®—ã–º–∫–µ–Ω—Ç - “ö–∞–∑–∞“õ—Å—Ç–∞–Ω–Ω—ã“£ —ñ—Ä—ñ “õ–∞–ª–∞–ª–∞—Ä—ã. "
        f"{city_name} - –æ—Å—ã –∞–π–º–∞“õ—Ç–∞—Ä–¥–∞“ì—ã –º–∞“£—ã–∑–¥—ã –∂–µ—Ä."
    )
    
    question = f"{city_name} –∞–π–º–∞“ì—ã–Ω–¥–∞“ì—ã –∞—É–∞ —Ä–∞–π—ã –∂”ô–Ω–µ –∫–ª–∏–º–∞—Ç —Ç—É—Ä–∞–ª—ã –Ω–µ –∞–π—Ç—É“ì–∞ –±–æ–ª–∞–¥—ã?"
    
    try:
        result = qa_model(question=question, context=context)
        answer = result['answer']
    except Exception as e:
        answer = f"–ö–µ—à—ñ—Ä—ñ“£—ñ–∑, –∞“õ–ø–∞—Ä–∞—Ç—Ç—ã ”©“£–¥–µ—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ —à—ã“õ—Ç—ã. {city_name} —Ç—É—Ä–∞–ª—ã –Ω–µ–≥—ñ–∑–≥—ñ –∞“õ–ø–∞—Ä–∞—Ç: –û—Ä—Ç–∞ –ê–∑–∏—è/–ú–æ“£“ì–æ–ª–∏—è –∞–π–º–∞“ì—ã–Ω–¥–∞“ì—ã –º–∞“£—ã–∑–¥—ã “õ–∞–ª–∞."
        
    return answer

# 2.2. ”®—Å—ñ–º–¥—ñ–∫/–ú–∞–ª –ê—É—Ä—É—ã –¢–∞–Ω—É (PREMIUM –§–£–ù–ö–¶–ò–Ø–°–´)
def premium_disease_detector(image: Image.Image) -> str:
    """–°—É—Ä–µ—Ç—Ç—ñ —Ç–∞–ª–¥–∞–ø, –Ω–∞“õ—Ç—ã –∞—É—Ä—É–¥—ã/–∑–∏—è–Ω—ã–Ω –∞–Ω—ã“õ—Ç–∞–π–¥—ã. –ë“±–ª –±–æ–ª–∞—à–∞“õ—Ç–∞ –∞“õ—ã–ª—ã –±–æ–ª–∞–¥—ã."""
    
    # PREMIUM —Ñ—É–Ω–∫—Ü–∏—è—Å—ã –µ–∫–µ–Ω—ñ–Ω –∫”©—Ä—Å–µ—Ç—É –∂”ô–Ω–µ $7 —Ç—É—Ä–∞–ª—ã –µ—Å–∫–µ—Ä—Ç—É
    premium_message = (
        "üî¥ **PREMIUM –ê–ù–ê–õ–ò–ó (FUTURE $7/–ê–ô)** üî¥\n"
        "–ë“±–ª —Ñ—É–Ω–∫—Ü–∏—è –µ–≥—ñ–Ω –∂”ô–Ω–µ –º–∞–ª –∞—É—Ä—É–ª–∞—Ä—ã–Ω **–∂–æ“ì–∞—Ä—ã –¥”ô–ª–¥—ñ–∫–ø–µ–Ω** –∞–Ω—ã“õ—Ç–∞—É“ì–∞ –∞—Ä–Ω–∞–ª“ì–∞–Ω. "
        "“ö–∞–∑—ñ—Ä–≥—ñ —Ç–µ–≥—ñ–Ω (Free) –∂–æ—Å–ø–∞—Ä–¥–∞ –º–æ–¥–µ–ª—å–¥—ñ“£ –¥”ô–ª–¥—ñ–≥—ñ —Ç”©–º–µ–Ω –±–æ–ª—É—ã –º“Ø–º–∫—ñ–Ω.\n\n"
    )
    
    try:
        results = classifier(image)
        top_result = results[0]
        label = top_result['label'].split(',')[0]
        score = top_result['score']
        
        if score > 0.6:
            analysis = f"–ê–Ω—ã“õ—Ç–∞–º–∞: **{label}** (–°–µ–Ω—ñ–º–¥—ñ–ª—ñ–∫: {score:.2f}). –ë“±–ª –∂–∏—ñ –∫–µ–∑–¥–µ—Å–µ—Ç—ñ–Ω –º”ô—Å–µ–ª–µ–≥–µ “±“õ—Å–∞–π–¥—ã. –¢–æ–ª—ã“õ —à–µ—à—ñ–º–¥–µ—Ä–¥—ñ –∂”ô–Ω–µ –∂–æ“ì–∞—Ä—ã –¥”ô–ª–¥—ñ–∫—Ç—ñ **$7 –ü—Ä–µ–º–∏—É–º** –∂–æ—Å–ø–∞—Ä—ã–Ω–∞–Ω –∞–ª—ã“£—ã–∑!"
        else:
            analysis = f"–ë“±–ª –Ω—ã—Å–∞–Ω–Ω—ã“£ —Å–∏–ø–∞—Ç—ã –∞–Ω—ã“õ—Ç–∞–ª–º–∞–¥—ã. –î”ô–ª—ñ—Ä–µ–∫ –Ω”ô—Ç–∏–∂–µ –∞–ª—É “Ø—à—ñ–Ω **$7 –ü—Ä–µ–º–∏—É–º** –∂–æ—Å–ø–∞—Ä—ã–Ω–∞ ”©—Ç—ñ“£—ñ–∑."

        return premium_message + analysis
            
    except Exception as e:
        return premium_message + f"–°—É—Ä–µ—Ç—Ç—ñ —Ç–∞–ª–¥–∞—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ —à—ã“õ—Ç—ã: {e}. –ñ–∞–¥ –∂–µ—Ç—ñ—Å–ø–µ—É—à—ñ–ª—ñ–≥—ñ –±–æ–ª—É—ã –º“Ø–º–∫—ñ–Ω."

# 2.3. –ñ–∞–ª–ø—ã –ñ–∞“ì–¥–∞–π–¥—ã –°–∏–ø–∞—Ç—Ç–∞—É (–¢–µ–≥—ñ–Ω)
def free_situation_captioner(image: Image.Image) -> str:
    """–°—É—Ä–µ—Ç—Ç—ñ —Å”©–∑–±–µ–Ω —Å–∏–ø–∞—Ç—Ç–∞–ø, –∂–∞–ª–ø—ã –∂–∞“ì–¥–∞–π —Ç—É—Ä–∞–ª—ã –º”ô–ª—ñ–º–µ—Ç –±–µ—Ä–µ–¥—ñ."""
    try:
        caption = captioner(image)[0]['generated_text']
        return f"–°—É—Ä–µ—Ç—Ç—ñ“£ –∂–∞–ª–ø—ã —Å–∏–ø–∞—Ç—Ç–∞–º–∞—Å—ã: **'{caption}'**. –ï–≥–µ—Ä –±“±–ª ”©—Å—ñ–º–¥—ñ–∫ –Ω–µ–º–µ—Å–µ –º–∞–ª –±–æ–ª—Å–∞, –æ–Ω—ã“£ –∂–∞“ì–¥–∞–π—ã —Ç—É—Ä–∞–ª—ã “õ–æ—Å—ã–º—à–∞ –∞“õ–ø–∞—Ä–∞—Ç—Ç—ã **–ü—Ä–µ–º–∏—É–º** “õ–æ–π—ã–Ω–¥—ã—Å—ã–Ω–∞–Ω —Å“±—Ä–∞“£—ã–∑."
    except Exception as e:
        return f"–°–∏–ø–∞—Ç—Ç–∞–º–∞ –±–µ—Ä—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ —à—ã“õ—Ç—ã: {e}."

# ----------------------------------------------------------------------
# 3. GRADIO –ò–ù–¢–ï–†–§–ï–ô–°–Ü
# ----------------------------------------------------------------------

# –ê—É–∞-—Ä–∞–π—ã “õ–æ–π—ã–Ω–¥—ã—Å—ã (–¢–µ–≥—ñ–Ω)
weather_tab = gr.Interface(
    fn=weather_predictor,
    inputs=gr.Textbox(label="“ö–∞–ª–∞–Ω—ã“£ –∞—Ç—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑ (–º—ã—Å–∞–ª—ã, ”®–ª–≥–∏–π, –ê–ª–º–∞—Ç—ã, –ê—Å—Ç–∞–Ω–∞)"),
    outputs="text",
    title="1. –ê—É–∞ –†–∞–π—ã –∂”ô–Ω–µ –ö–ª–∏–º–∞—Ç (–¢–µ–≥—ñ–Ω)",
    description="–ë–∞—è–Ω-”®–ª–≥–∏–π –º–µ–Ω “ö–∞–∑–∞“õ—Å—Ç–∞–Ω “õ–∞–ª–∞–ª–∞—Ä—ã–Ω–∞ –±–∞–π–ª–∞–Ω—ã—Å—Ç—ã –∂–∞–ª–ø—ã –∫–ª–∏–º–∞—Ç—Ç—ã“õ –∞“õ–ø–∞—Ä–∞—Ç—Ç—ã –±–µ—Ä–µ–¥—ñ."
)

# ”®—Å—ñ–º–¥—ñ–∫/–ú–∞–ª –ê—É—Ä—É—ã –¢–∞–Ω—É “õ–æ–π—ã–Ω–¥—ã—Å—ã (–ü—Ä–µ–º–∏—É–º)
premium_tab = gr.Interface(
    fn=premium_disease_detector,
    inputs=gr.Image(type="pil", label="”®—Å—ñ–º–¥—ñ–∫, –µ–≥—ñ–Ω –Ω–µ–º–µ—Å–µ –º–∞–ª —Å—É—Ä–µ—Ç—ñ–Ω –∂“Ø–∫—Ç–µ“£—ñ–∑"),
    outputs="text",
    title="2. ”®—Å—ñ–º–¥—ñ–∫/–ú–∞–ª –ê—É—Ä—É—ã–Ω –¢–∞–Ω—É (PREMIUM)",
    description="üî¥ PREMIUM: –°—É—Ä–µ—Ç –±–æ–π—ã–Ω—à–∞ –Ω–∞“õ—Ç—ã –∞—É—Ä—É–¥—ã –∞–Ω—ã“õ—Ç–∞—É –∂”ô–Ω–µ —à–µ—à—É –∂–æ–ª–¥–∞—Ä—ã (–ë–æ–ª–∞—à–∞“õ—Ç–∞ $7/–∞–π)."
)

# –ñ–∞–ª–ø—ã –°–∏–ø–∞—Ç—Ç–∞–º–∞ “õ–æ–π—ã–Ω–¥—ã—Å—ã (–¢–µ–≥—ñ–Ω)
caption_tab = gr.Interface(
    fn=free_situation_captioner,
    inputs=gr.Image(type="pil", label="–ö–µ–∑ –∫–µ–ª–≥–µ–Ω —Å—É—Ä–µ—Ç—Ç—ñ –∂“Ø–∫—Ç–µ“£—ñ–∑"),
    outputs="text",
    title="3. –ñ–∞–ª–ø—ã –ñ–∞“ì–¥–∞–π–¥—ã –°–∏–ø–∞—Ç—Ç–∞—É (–¢–µ–≥—ñ–Ω)",
    description="–ö–µ–∑ –∫–µ–ª–≥–µ–Ω —Å—É—Ä–µ—Ç—Ç—ñ —Å”©–∑–±–µ–Ω —Å–∏–ø–∞—Ç—Ç–∞–π–¥—ã."
)

# “ö–æ—Å—ã–º—à–∞–Ω—ã —ñ—Å–∫–µ “õ–æ—Å—É
demo = gr.TabbedInterface(
    [weather_tab, premium_tab, caption_tab],
    ["1. –ê—É–∞ –†–∞–π—ã (Free)", "2. PREMIUM –¢–∞–Ω—É", "3. –ñ–∞–ª–ø—ã –°–∏–ø–∞—Ç—Ç–∞–º–∞ (Free)"],
    title="AgroAssist “ö–∞–∑–∞“õ—Å—Ç–∞–Ω & –ë–∞—è–Ω-”®–ª–≥–∏–π: –ê—É—ã–ª –®–∞—Ä—É–∞—à—ã–ª—ã“ì—ã –ö”©–º–µ–∫—à—ñ—Å—ñ"
)

# Render CPU-–¥–∞ —ñ—Å–∫–µ “õ–æ—Å—É “Ø—à—ñ–Ω “õ–∞–∂–µ—Ç—Ç—ñ –ø–æ—Ä—Ç
if __name__ == "__main__":
    # “ö–∞—Ç–µ—Å—ñ–∑ —ñ—Å–∫–µ “õ–æ—Å—É “Ø—à—ñ–Ω server_port=8080 –∂”ô–Ω–µ host=0.0.0.0
    demo.launch(server_name="0.0.0.0", server_port=8080)
```eof

---

### üöÄ –ê—è“õ—Ç–∞—É “ö–∞–¥–∞–º—ã

1.  GitHub-—Ç–∞“ì—ã ”©—Ä—ñ—Å–∫–µ **–∫–æ–¥—Ç—ã “õ–æ–π—ã“£—ã–∑**.
2.  –ë–µ—Ç—Ç—ñ“£ –µ“£ —Ç”©–º–µ–Ω–≥—ñ –∂–∞“ì—ã–Ω–∞ –∂—ã–ª–∂—ã–ø, **Commit changes** (”®–∑–≥–µ—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Å–∞“õ—Ç–∞—É) –±–∞—Ç—ã—Ä–º–∞—Å—ã–Ω –±–∞—Å—ã“£—ã–∑.

–°—ñ–∑ –º“±–Ω—ã –∂–∞—Å–∞“ì–∞–Ω–Ω–∞–Ω –∫–µ–π—ñ–Ω, –º–∞“ì–∞–Ω Render-–¥–µ–≥—ñ **–∂–∞“£–∞ –ª–æ–≥—Ç–∞—Ä–¥—ã“£ —Å—É—Ä–µ—Ç—ñ–Ω** –∂—ñ–±–µ—Ä—ñ“£—ñ–∑! –ë—ñ–∑–¥—ñ“£ "“Ø–ª–∫–µ–Ω –∫–æ–º–ø–∞–Ω–∏—è" –∂“±–º—ã—Å—ã–Ω –±–∞—Å—Ç–∞—É“ì–∞ –±—ñ—Ä “õ–∞–¥–∞–º “õ–∞–ª–¥—ã!
